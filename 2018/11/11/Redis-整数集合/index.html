<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=""><meta name="author" content="8090Lambert"><meta name="google-site-verification" content="NlVkPYQIz-6FEWSYj-zlvN-gVromFNmq2v7hUK_WyyM"><meta name="sogou_site_verification" content="GFRFxFpBEM"><meta property="og:title" content="Redis-整数集合"><meta property="og:description" content="A Programmer With Coding."><meta property="og:site_name" content="8090Lambert | Blog"><meta property="og:type" content="article"><meta property="og:image" content="http://8090lambert.cn"><link rel="alternate" href="/atom.xml" title="8090Lambert | Blog" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><title>8090Lambert | Blog</title><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-146263529-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>var _hmt=_hmt||[]</script><script async src="//hm.baidu.com/hm.js?dfc9714182f4393d85cb19cc7ad9c231"></script></head><body><nav class="navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="collapse navbar-collapse site-menu"><ul class="nav navbar-nav navbar-right"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/about">About</a></li><li> <a href="mailto:<juzs215@gmail.com>">Email</a></li><li><a href="https://github.com/8090Lambert"><i class="icon fa fa-github fa-lg"></i></a></li></ul></div></div></nav><header class="site-header header-background intro-header" style="background-image:url(/img/banner.jpg)"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="page-title with-background-image"><p class="title">Redis-整数集合</p><p class="subtitle"></p></div></div></div></div></header><article><div class="container typo"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-info text-muted"> <span class="author info">By 8090Lambert</span> <span class="date-time info">On <span class="date">2018-11-11T23:25:02+08:00</span></span></div><div class="post-tags text-muted"> Tags: <a class="tag" href="/tags/redis/">#redis</a></div><div class="post-content"><p>在 Redis 中，如果有用过它的 <code>set</code> 集合，底层的实现整数集合。<br>整数集合，就是只能包括整数值的元素，我们试着创建一个整数集合<br><img src="http://8090lambert.cn/images/blog/intset/inset_00.png" alt="创建一个整数集合"></p><p>它的结构很简单，具体的源码在 <code>src/intset.h</code> 文件中</p><pre><code>typedef struct intset {
    uint32_t encoding;  // 编码类型
    uint32_t length;    // 元素数量
    int8_t contents[];  // 保存元素数组
} intset;
</code></pre><p>在 <code>contents</code> 数组中，集合的每个元素，都对应着数组的一个元素，<br>他们按照从小到大的顺序，有序的排列着，并且每个元素在数组中都是唯一的。<br><code>length</code> 记录了集合中现有元素的数量，可以 O（1）的方式，每次快速<br>返回 <code>contents</code> 数组的数量。<code>encoding</code> 属性是值，<code>contents</code> 数组<br>中的每个元素，都是以什么类型存的，共有三种类型：</p><pre><code>/* Note that these encodings are ordered, so:
 * INTSET_ENC_INT16 &lt; INTSET_ENC_INT32 &lt; INTSET_ENC_INT64. */
#define INTSET_ENC_INT16 (sizeof(int16_t))  // int16, -2^15 ~ 2^15 - 1 
#define INTSET_ENC_INT32 (sizeof(int32_t))  // int32, -2^31 ~ 2^31 - 1  
#define INTSET_ENC_INT64 (sizeof(int64_t))  // int64, -2^63 ~ 2^63 - 1
</code></pre><p>一个拥有5个int16类型的整数集合<br><img src="http://8090lambert.cn/images/blog/intset/inset_01.png" alt=""></p><h3 id="集合的类型转换"><a href="#集合的类型转换" class="headerlink" title="集合的类型转换"></a>集合的类型转换</h3><p>当我们需要往现有集合中增加插入一个整数的时候，如果要添加的整数的大小不满足<br>现有集合的编码类型，则需要对现有集合的每个元素转换类型。具体步骤：</p><ol><li>根据新元素的类型，扩展整数集合的空间大小；</li><li>将现有元素类型，转换为集合中最大数所属类型，保持原有顺序，再添加新元素至合适位置；</li><li>修改 <code>contents</code> 数组长度 <code>length</code> 和 编码类型 <code>encoding</code></li></ol><p>例如，有一个集合，包含3个元素，分别是 <code>1，2，3</code>，集合的 <code>encoding</code> 属性<br>为 <code>INTSET_ENC_INT16</code>，所占空间为 <code>3 * 16 = 48</code> 位，6个字节。现在要将<br>65535 添加到集合中，按照上面说的步骤：</p><ul><li>首先，因为 65535 超过 <code>INTSET_ENC_INT16</code>，属于 <code>INTSET_ENC_INT32</code> 范围内，<br>所以，需要对空间进行重新分配，新的空间需要 <code>4 * 32 = 128</code> 位，16个字节；</li><li>接着，从 96 ~ 127 位，留给最后一个 <code>65535</code> 元素，剩下的三个元素，从 95 位开始，<br>至 <code>96 - 32 = 64</code> 位，保存3，从 63 位开始至 <code>64 - 32 = 32</code> 位，保存2，剩下的<br>0 至 31 位，保存 1，最后将要插入的 65535 放入最先预留的 96 - 127 位；</li><li>将 <code>length</code> 改为4， <code>encoding</code> 改为 <code>INTSET_ENC_INT32</code></li></ul><p>至此，类型转换就完成了。整数集合，不会将高位的 <code>encoding</code>，改为低位，如果说，<br>因为增加元素 <code>encoding</code> 的类型改为高位，即使后来再删除元素，<code>encoding</code> 始终<br>就是增加时修改的值。</p></div><section class="comments" id="comments"><div id="gitment_thread"></div><link rel="stylesheet" href="//unpkg.com/gitment/style/default.css"><script src="//unpkg.com/gitment/dist/gitment.browser.js"></script><script>var gitment=new Gitment({id:"{{ page.date }}",owner:"8090Lambert",repo:"8090Lambert.github.io",oauth:{client_id:"b2e729afbaa762a4cecc",client_secret:"cb9b28cda56154edecbcf76d2ea66e5a0e12c209"}});gitment.render("comments")</script></section></div></div></div></article><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="copyright text-muted"> &copy; 2016 - 2021<span class="with-love"><i class="fa fa-heart"></i></span> <span class="author">8090Lambert</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></p><p class="visit-statistics"> <span id="busuanzi_container_site_pv">本站总访问：<span id="busuanzi_value_site_pv"></span>次 &nbsp;&nbsp;&nbsp;&nbsp;</span></p><p></p></div></div></div></footer><script src="/js/highlight.pack.js"></script><script>document.addEventListener("DOMContentLoaded",function(e){Array.prototype.slice.call(document.getElementsByTagName("pre")).forEach(function(e,t){hljs.highlightBlock(e)})})</script></body></html>