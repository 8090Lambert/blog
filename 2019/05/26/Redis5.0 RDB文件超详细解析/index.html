<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=""><meta name="author" content="8090Lambert"><meta name="google-site-verification" content="NlVkPYQIz-6FEWSYj-zlvN-gVromFNmq2v7hUK_WyyM"><meta name="sogou_site_verification" content="GFRFxFpBEM"><meta property="og:title" content="Redis5.0 RDB文件超详细解析"><meta property="og:description" content="A Programmer With Coding."><meta property="og:site_name" content="8090Lambert | Blog"><meta property="og:type" content="article"><meta property="og:image" content="http://8090lambert.cn"><link rel="alternate" href="/atom.xml" title="8090Lambert | Blog" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><title>8090Lambert | Blog</title><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-146263529-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>var _hmt=_hmt||[]</script><script async src="//hm.baidu.com/hm.js?dfc9714182f4393d85cb19cc7ad9c231"></script></head><body><nav class="navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="collapse navbar-collapse site-menu"><ul class="nav navbar-nav navbar-right"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/about">About</a></li><li> <a href="mailto:<juzs215@gmail.com>">Email</a></li><li><a href="https://github.com/8090Lambert"><i class="icon fa fa-github fa-lg"></i></a></li></ul></div></div></nav><header class="site-header header-background intro-header" style="background-image:url(/img/banner.jpg)"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="page-title with-background-image"><p class="title">Redis5.0 RDB文件超详细解析</p><p class="subtitle"></p></div></div></div></div></header><article><div class="container typo"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-info text-muted"> <span class="author info">By 8090Lambert</span> <span class="date-time info">On <span class="date">2019-05-26T20:14:26+08:00</span></span></div><div class="post-tags text-muted"> Tags: <a class="tag" href="/tags/redis/">#redis</a></div><div class="post-content"><h2 id="Redis-RDB介绍"><a href="#Redis-RDB介绍" class="headerlink" title="Redis RDB介绍"></a>Redis RDB介绍</h2><p><code>RDB</code> 是 Redis 将 server 端的内存中的 k/v 对以二进制的方式，持久化存储的一种文件形式。<br><em>文件中，一般会以 对象的长度+对象 的格式来存储</em>，只要根据这个格式，就能渐进的遍历整个文件。<br><code>Redis</code> 还支持开启 <code>LZF</code> 的压缩算法，可以牺牲CPU时间，来减少 <code>RDB</code> 文件的大小；如果开启<code>LZF</code>并且超过<code>20</code>个bytes时，<br>会将压缩后的字符写入文件。</p><h3 id="RDB文件格式"><a href="#RDB文件格式" class="headerlink" title="RDB文件格式"></a>RDB文件格式</h3><pre><code>➜  go-redis-parser od -A x -t x1c -v ./teststub/dumpV9.rdb
000000  52  45  44  49  53  30  30  30  39  fa  09  72  65  64  69  73
         R   E   D   I   S   0   0   0   9 372  \t   r   e   d   i   s
000010  2d  76  65  72  05  35  2e  30  2e  35  fa  0a  72  65  64  69
         -   v   e   r 005   5   .   0   .   5 372  \n   r   e   d   i
000020  73  2d  62  69  74  73  c0  40  fa  05  63  74  69  6d  65  c2
         s   -   b   i   t   s 300   @ 372 005   c   t   i   m   e 302
000030  71  8a  8d  5d  fa  08  75  73  65  64  2d  6d  65  6d  c2  30
         q 212 215   ] 372  \b   u   s   e   d   -   m   e   m 302   0
000040  e0  0f  00  fa  0c  61  6f  66  2d  70  72  65  61  6d  62  6c
       340 017  \0 372  \f   a   o   f   -   p   r   e   a   m   b   l
000050  65  c0  00  fe  00  fb  06  00  f9  00  00  01  73  01  61  f9
         e 300  \0 376  \0 373 006  \0 371  \0  \0 001   s 001   a 371
000060  03  0e  02  6c  69  01  11  11  00  00  00  0d  00  00  00  02
       003 016 002   l   i 001 021 021  \0  \0  \0  \r  \0  \0  \0 002
000070  00  00  01  61  03  01  62  ff  f9  00  02  03  73  65  74  02
        \0  \0 001   a 003 001   b 377 371  \0 002 003   s   e   t 002
000080  01  62  01  61  f9  00  0f  06  73  74  72  65  61  6d  01  10
       001   b 001   a 371  \0 017 006   s   t   r   e   a   m 001 020
000090  00  00  01  6d  70  b5  4a  7e  00  00  00  00  00  00  00  00
        \0  \0 001   m   p 265   J   ~  \0  \0  \0  \0  \0  \0  \0  \0
0000a0  40  52  52  00  00  00  18  00  03  01  00  01  02  01  84  6e
         @   R   R  \0  \0  \0 030  \0 003 001  \0 001 002 001 204   n
0000b0  61  6d  65  05  83  61  67  65  04  00  01  02  01  00  01  00
         a   m   e 005 203   a   g   e 004  \0 001 002 001  \0 001  \0
0000c0  01  87  4c  61  6d  62  65  72  74  08  1d  01  05  01  02  01
       001 207   L   a   m   b   e   r   t  \b 035 001 005 001 002 001
0000d0  f2  33  8c  00  04  00  01  84  4a  61  63  6b  05  1a  01  05
       362   3 214  \0 004  \0 001 204   J   a   c   k 005 032 001 005
0000e0  01  02  01  f2  9c  ad  00  04  00  01  83  54  6f  6d  04  1e
       001 002 001 362 234 255  \0 004  \0 001 203   T   o   m 004 036
0000f0  01  05  01  ff  03  81  00  00  01  6d  70  b5  f8  1a  00  01
       001 005 001 377 003 201  \0  \0 001   m   p 265 370 032  \0 001
000100  05  67  72  6f  75  70  00  00  00  00  f9  00  0c  04  7a  73
       005   g   r   o   u   p  \0  \0  \0  \0 371  \0  \f 004   z   s
000110  65  74  15  15  00  00  00  12  00  00  00  04  00  00  01  61
         e   t 025 025  \0  \0  \0 022  \0  \0  \0 004  \0  \0 001   a
000120  03  f2  02  01  62  03  f3  ff  f9  03  0d  01  68  11  11  00
       003 362 002 001   b 003 363 377 371 003  \r 001   h 021 021  \0
000130  00  00  0d  00  00  00  02  00  00  01  61  03  01  61  ff  ff
        \0  \0  \r  \0  \0  \0 002  \0  \0 001   a 003 001   a 377 377
000140  0e  e0  f7  31  2f  37  16  df
       016 340 367   1   /   7 026 337
000148
</code></pre><p>这是一个 <code>version 9</code> 的 RDB 文件</p><h3 id="魔数-Magic-Number"><a href="#魔数-Magic-Number" class="headerlink" title="魔数 Magic Number"></a>魔数 Magic Number</h3><p>文件前 9 个字节是一个 <code>魔数</code>，5 个字节<code>REDIS</code> 和 4 个字节的版本号 <code>009</code>。</p><h3 id="辅助字段-Aux-Fields"><a href="#辅助字段-Aux-Fields" class="headerlink" title="辅助字段 Aux Fields"></a>辅助字段 Aux Fields</h3><p>通用字符串字段，用于向RDB添加状态，<code>Version 7</code> 加入的，向后兼容。AUX字段由两个字符串组成：<code>键和值</code>。<br>整理了下，除了 <code>lua</code>，有这些字段：</p><ul><li>redis-ver：版本号</li><li>redis-bits：OS Arch</li><li>ctime：RDB文件创建时间</li><li>used-mem：使用内存大小</li><li>repl-stream-db：在server.master客户端中选择的数据库</li><li>repl-id：当前实例 replication ID</li><li>repl-offset：当前实例复制的偏移量</li></ul><h3 id="数据库索引"><a href="#数据库索引" class="headerlink" title="数据库索引"></a>数据库索引</h3><p><img src="https://raw.githubusercontent.com/8090Lambert/material/master/rdb-select.jpg" alt=""><br>fe(0xfe)，fb(0xfb)是 10 进制的 254 和 251，在 RDB 分别对应着，<code>SELECT_DB</code>和<code>RESIZE_DB</code>。 每一个<br><code>SELECTDB</code>后都会紧跟着<code>RESIZEDB</code>，后者表示的是当前数据库<code>hashtable</code>键大小的提示，每次切换数据库时提前读到，避免不必要的<code>rehash</code>。</p><h3 id="数据库键值对"><a href="#数据库键值对" class="headerlink" title="数据库键值对"></a>数据库键值对</h3><p>接下来，读到的就是<code>Redis</code>中所有存储着的<code>K/V</code>对：<br><img src="https://raw.githubusercontent.com/8090Lambert/material/master/rdb-datatype.jpg" alt="类型对照表"></p><h4 id="LFU-LRU-Idle"><a href="#LFU-LRU-Idle" class="headerlink" title="LFU/LRU Idle"></a>LFU/LRU Idle</h4><p>后面f9(0xf9)是 10 进制的 249，是表示 key 对象的<code>lfu_idle</code>，这个字段是只有开启<code>maxmemory-policy</code>并且设置为<code>volatile-lfu</code>或<code>allkeys-lfu</code>才会写入文件。<br><code>LRU</code>的同理，不过前缀是 f8(0xf8)，<code>maxmemory-policy</code>要设置为：<code>allkeys-lru</code>和<code>volatile-lru</code>。</p><h4 id="String结构"><a href="#String结构" class="headerlink" title="String结构"></a>String结构</h4><p>00(0x00)是 10 进制的 0，表示<code>string</code>类型的对象，01 指<code>key</code>是一个字节长度：“s”, <code>value</code> 也是一个字节长度：“a”,</p><h4 id="List结构"><a href="#List结构" class="headerlink" title="List结构"></a>List结构</h4><p>0e(0x0e)是 10 进制的 14，表示<code>list</code>类型的对象（在3.2版本之前，是由<code>ziplist</code>和<code>linkedlist</code>结构保存，之后存储是<code>quicklist</code>）；2个字节长度的<code>key</code>：”li”,<br>下来分别是一个长度的<code>items</code>：”a” 和 “b”</p><h4 id="Set结构"><a href="#Set结构" class="headerlink" title="Set结构"></a>Set结构</h4><p>2，表示<code>Set</code>类型对象，3个长度 “set”，两个<code>members</code>：”a” 和 “b”</p><h4 id="Stream结构"><a href="#Stream结构" class="headerlink" title="Stream结构"></a>Stream结构</h4><p>继 <code>module</code> 之后，redis 在 5.0 增加了新的数据类型 <code>Stream</code>，不了解的同学可以Google下，很多介绍的文章。根据作者自己说，它也是充分借鉴了 <code>kafka</code> 的设计思想，在已有 <code>list</code> 的基础上增加了另一种流式类型。<br>基本。<br>0f(0x0f)是 10 进制的 15，是<code>Stream</code>类型的对象，5个长度的<code>key</code>:”stream”。然后是 <code>StreamId</code>结构体，<br><code>6d 70 b5 4a 7e</code>分别是 10 进制的（109 112 181 74 126），二进制 <code>01101101 01110000 10110101 01001010 01111110</code>，因为毫秒是<code>uint</code>，加上符号位即：<code>1 01101101 01110000 10110101 01001010 01111110</code> 对应如图所示:<br><img src="https://raw.githubusercontent.com/8090Lambert/material/master/20190927132103.png" alt=""><br><code>first-entry</code> 恰好是创建<code>stream</code>的毫秒数，后面跟着8位的随机数<code>0</code>；然后是<code>entry</code>结构，每个<code>entry</code>结构前面，也会有和<code>streamId</code>相同的<code>messageId</code>，这里就不具体逐位分析了。长度是 3，第一个字段：”name”;<br>第二个字段：”age”，3个<code>entry</code>分别是<code>name:Lambert,age:29</code>、<code>name:Jack,age:26</code>、<code>name:Tom,age:30</code>；下来是消费组<code>Group</code>，名为：<code>group</code> 的消费组，因为没有任何消费，所以偏移量<code>pending entry list</code>都是<code>0</code>。</p><h4 id="ZSet结构"><a href="#ZSet结构" class="headerlink" title="ZSet结构"></a>ZSet结构</h4><p>0c 是 10 进制的 12，以<code>ziplist</code>结构存储的<code>Sortedset</code>类型，4个长度的<code>key</code>：”zset”，接下来的 4 表示：4个元素，<code>zset</code>会将<code>member</code>和<code>score</code>一起保存，所以，就是2组<code>members</code>；分别是：<code>{memeber:&quot;a&quot;,score:1}</code>、<code>{member:&quot;b&quot;,score:2}</code>。</p><h4 id="Hash结构"><a href="#Hash结构" class="headerlink" title="Hash结构"></a>Hash结构</h4><p>0d(13) 是<code>RDB_TYPE_HASH_ZIPLIST</code>，表示是<code>ziplist</code>存储的<code>hash</code>类型数据，1 个长度的key：”h”。<br><code>key</code>后面的2，存着<code>hash</code>结构的<code>field</code>和<code>value</code>；在 field 和 value 前面的 1，分别是指各自的长度，都是 “a”</p><h3 id="文件EOF"><a href="#文件EOF" class="headerlink" title="文件EOF"></a>文件EOF</h3><p>ff(255) EOF，在所有数据写完结束后，会以一个EOF结尾</p><h3 id="CheckSum"><a href="#CheckSum" class="headerlink" title="CheckSum"></a>CheckSum</h3><p>从<code>Version 5</code> 开始，如果在配置文件中开启<code>rdbchecksum yes</code>，会在<code>RDB</code>文件的结尾处，用 8 个字节保存通过<code>CRC64</code>计算整个文件内容的检验和。</p></div><section class="comments" id="comments"><div id="gitment_thread"></div><link rel="stylesheet" href="//unpkg.com/gitment/style/default.css"><script src="//unpkg.com/gitment/dist/gitment.browser.js"></script><script>var gitment=new Gitment({id:"{{ page.date }}",owner:"8090Lambert",repo:"8090Lambert.github.io",oauth:{client_id:"b2e729afbaa762a4cecc",client_secret:"cb9b28cda56154edecbcf76d2ea66e5a0e12c209"}});gitment.render("comments")</script></section></div></div></div></article><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="copyright text-muted"> &copy; 2016 - 2021<span class="with-love"><i class="fa fa-heart"></i></span> <span class="author">8090Lambert</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></p><p class="visit-statistics"> <span id="busuanzi_container_site_pv">本站总访问：<span id="busuanzi_value_site_pv"></span>次 &nbsp;&nbsp;&nbsp;&nbsp;</span></p><p></p></div></div></div></footer><script src="/js/highlight.pack.js"></script><script>document.addEventListener("DOMContentLoaded",function(e){Array.prototype.slice.call(document.getElementsByTagName("pre")).forEach(function(e,t){hljs.highlightBlock(e)})})</script></body></html>