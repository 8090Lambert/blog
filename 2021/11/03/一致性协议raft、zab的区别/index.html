<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=""><meta name="author" content="8090Lambert"><meta name="google-site-verification" content="NlVkPYQIz-6FEWSYj-zlvN-gVromFNmq2v7hUK_WyyM"><meta name="sogou_site_verification" content="GFRFxFpBEM"><meta property="og:title" content="一致性协议raft、zab的区别"><meta property="og:description" content="A Programmer With Coding."><meta property="og:site_name" content="8090Lambert | Blog"><meta property="og:type" content="article"><meta property="og:image" content="http://8090lambert.cn"><link rel="alternate" href="/atom.xml" title="8090Lambert | Blog" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><title>8090Lambert | Blog</title><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-146263529-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>var _hmt=_hmt||[]</script><script async src="//hm.baidu.com/hm.js?dfc9714182f4393d85cb19cc7ad9c231"></script></head><body><nav class="navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="collapse navbar-collapse site-menu"><ul class="nav navbar-nav navbar-right"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/about">About</a></li><li> <a href="mailto:<juzs215@gmail.com>">Email</a></li><li><a href="https://github.com/8090Lambert"><i class="icon fa fa-github fa-lg"></i></a></li></ul></div></div></nav><header class="site-header header-background intro-header" style="background-image:url(/img/banner.jpg)"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="page-title with-background-image"><p class="title">一致性协议raft、zab的区别</p><p class="subtitle"></p></div></div></div></div></header><article><div class="container typo"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-info text-muted"> <span class="author info">By 8090Lambert</span> <span class="date-time info">On <span class="date">2021-11-03T14:46:43+08:00</span></span></div><div class="post-content"><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>为解决大型分布式系统中多个副本日志及状态机一致性问题。</p><h2 id="Raft介绍"><a href="#Raft介绍" class="headerlink" title="Raft介绍"></a>Raft介绍</h2><p>协议由三部分组成：Leader election、Log Replication、Safety。分别对应着三种状态的身份：<br>leader(工作时的首要进程)、candidate(选举时可能会成为leader)、follower(副本).</p><h2 id="Raft选举"><a href="#Raft选举" class="headerlink" title="Raft选举"></a>Raft选举</h2><p>选举的时机一般有两种：</p><ul><li>初始化时，系统中不存在 Leader 角色。所有节点均为 candidate 角色</li><li>follower 在 election timeout 后没有收到 leader心跳，follower 变为 candidate 角色</li></ul><p>candidate向其他节点发起 leader election 请求，得到超过半数其他 candidate 的回复后成为leader. 同时选举的过程存在极端情况：</p><ul><li>所有选票被多个节点瓜分，没有选出leader。</li></ul><p>为避免发生多个 candidate 同时发生选举，而导致的多次选举。raft采用 <strong>random election timeout</strong> 机制，使每个节点的超时时间不同。<br>一般来说需要保证 election timeout &gt; broadcast 的间隔时间，否则，election timeout 无法说明与leader断开连接.</p><h2 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h2><h3 id="两个限制条件保证日志复制的安全"><a href="#两个限制条件保证日志复制的安全" class="headerlink" title="两个限制条件保证日志复制的安全"></a>两个限制条件保证日志复制的安全</h3><p>限制一：选举阶段节点 m 向节点 n 发送了 RequestVote RPC，如果节点 n 发现节点 m 的数据没有自己新，则节点 n 拒绝节点 m 的投票请求。<br>这里的“新”包含两个方面，term 更大的数据更新，term 相同，index更大的数据更新。</p><p>选举时，只有日志最新的candidate才有机会得到超过半数的投票。其中有这两个条件:</p><ul><li>term越大的节点越容易成为leader</li><li>term相同的情况下，index越大的节点越容易成为leader</li></ul><p>限制二：不直接提交之前 term 的log，必须通过提交本 term 的 log，间接的提交之前 term 的 log。<br>选举时，在条件1的情况下，term不同，可能选举出来的leader不包含所有过半提交的日志。要解决这个问题，需要在 那么就需要对过半提交通过限制二来约束。<br>一旦加上了这个限制意味着含有所有过半提交的日志的几个节点必然拥有目前最大的term，这样的话再次进行leader选举时，就避免了条件1的误判。</p><h2 id="Raft-对比-Zab"><a href="#Raft-对比-Zab" class="headerlink" title="Raft 对比 Zab"></a>Raft 对比 Zab</h2><h3 id="Leader-election-阶段"><a href="#Leader-election-阶段" class="headerlink" title="Leader election 阶段"></a>Leader election 阶段</h3><table><thead><tr><th style="text-align:left">Issue</th><th style="text-align:left">Raft</th><th style="text-align:left">Zab</th></tr></thead><tbody><tr><td style="text-align:left">Leader检测</td><td style="text-align:left">通过Follower心跳</td><td style="text-align:left">leader: 维护Quorum集合；<br> follower: 通过长链接</td></tr><tr><td style="text-align:left">过期leader判断</td><td style="text-align:left">term_id</td><td style="text-align:left">epoch</td></tr><tr><td style="text-align:left">leader投票过程</td><td style="text-align:left">每个节点每轮只投一次票</td><td style="text-align:left">每次选举节点可能产生多次投票，选出最新的</td></tr></tbody></table><ul><li>leader 可用性检查：Raft 协议 leader 宕机仅仅由 folower 进行检测，当 folower 收不到 leader 心跳时，则认为 leader 宕机，<br>变为 candidate。Zk 的 leader down 机分别由 leader 和 folower 检测，leader 维护了一个 Quorum 集合，当该 Quorum 集合不再超过半数，<br>leader 自动变为 LOOKING 状态。folower 与 leader 之间维护了一个超链接，连接断开则 folower 变为 LOOKING 状态。</li><li>过期 leader 的屏蔽：Raft 通过 term 识别过期的 leader。Zk 通过 Epoch识别过期的 leader。这点两者是相似的。</li><li>leader 选举的投票过程：Raft 每个选举周期每个节点只能投一次票，选举失败进入下次周期才能重新投票。<br>Zk 每次选举节点需要不断的变换选票以便选出数据最新的节点为 leader。</li><li>保证 commited 的数据出现在未来 leader 中：Raft选取 leader 时拒绝数据比自己旧的节点的投票。<br>Zk 通过在选取 leader 时不断更新选票使得拥有最新数据的节点当选 leader。</li></ul><p>Zab在leader选举出来后会立即进行数据同步过程，同步下最新的epoch（相当于term），数据同步之后就不会存在Raft（经过几个term变更后）日志错乱的现象。<br>Zab是正式对外提交服务之前先清理好数据的不一致问题，Raft是延迟清理的，在后续的复制过程中不断的进行纠正更新。</p><h3 id="Log-Replication-阶段"><a href="#Log-Replication-阶段" class="headerlink" title="Log Replication 阶段"></a>Log Replication 阶段</h3><table><thead><tr><th style="text-align:left">Issue</th><th style="text-align:left">Raft</th><th style="text-align:left">Zab</th></tr></thead><tbody><tr><td style="text-align:left">新leader数据同步</td><td style="text-align:left">通过AppendEntry Rpc每次同步</td><td style="text-align:left">通过 Recovery Phase 同步</td></tr><tr><td style="text-align:left">新leader数据同步量</td><td style="text-align:left">增量同步</td><td style="text-align:left">增量或全量同步</td></tr><tr><td style="text-align:left">之前未commit数据处理</td><td style="text-align:left">commit 当前term时，会将未提交数据一起commit</td><td style="text-align:left">Recovery Phase阶段commit</td></tr><tr><td style="text-align:left">新加入集群节点数据同步</td><td style="text-align:left">不阻塞写请求</td><td style="text-align:left">Recovery Phase 会阻塞写请求</td></tr></tbody></table><ul><li>选取新 leader 后数据同步：Raft 没有固定在某个特定的阶段做这件事情，通过每个节点的 AppendEntry RPC 分别做数据同步。<br>Zk 则在新leader 选举之后，有一个 Recovery Phase 做这个件事情。</li><li>选取新 leader 后同步的数据量：Raft 只需要传输和新 leader 差异的部分。Zab 的原始协议需要传输 leader 的全部数据，Zk 优化后，<br>视情况而定，最坏情况下需要传输 leader 全部数据。</li><li>新 leader 对之前 leader 未 commit 数据的处理：Raft 不会直接 commit 之前 leader 的数据，通过 commit 本 term 的数据间接的 commit 之前 leader 的数据。<br>Zk 在 Recovery Phase直接 commit 之前 leader 的数据。</li><li>新加入集群节点的数据同步：Raft 对于新加入集群的节点数据同步不会影响客户端的写请求。Zk 对于新加入集群的节点，需要单独走一下 Recovery Phase，<br>目前是通过读写锁同步的，因此会阻塞客户端的写请求。（Zk 可以在这里使用 copy-on-write 机制避免阻塞问题？？）</li></ul><h3 id="脑裂问题"><a href="#脑裂问题" class="headerlink" title="脑裂问题"></a>脑裂问题</h3><table><thead><tr><th style="text-align:left">Raft</th><th style="text-align:left">Zab</th></tr></thead><tbody><tr><td style="text-align:left">通过增加region leader角色 + lease机制，每个请求通过region leader转发至raft leader</td><td style="text-align:left">通过Quorum过半机制避免</td></tr></tbody></table><p>Tips： Etcd 不存在脑裂</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><blockquote><p><a href="https://niceaz.com/2018/11/03/raft-and-zab/" target="_blank" rel="noopener">https://niceaz.com/2018/11/03/raft-and-zab/</a><br><a href="https://www.jianshu.com/p/072380e12657" target="_blank" rel="noopener">https://www.jianshu.com/p/072380e12657</a></p></blockquote></div><section class="comments" id="comments"><div id="gitment_thread"></div><link rel="stylesheet" href="//unpkg.com/gitment/style/default.css"><script src="//unpkg.com/gitment/dist/gitment.browser.js"></script><script>var gitment=new Gitment({id:"{{ page.date }}",owner:"8090Lambert",repo:"8090Lambert.github.io",oauth:{client_id:"b2e729afbaa762a4cecc",client_secret:"cb9b28cda56154edecbcf76d2ea66e5a0e12c209"}});gitment.render("comments")</script></section></div></div></div></article><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="copyright text-muted"> &copy; 2016 - 2021<span class="with-love"><i class="fa fa-heart"></i></span> <span class="author">8090Lambert</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></p><p class="visit-statistics"> <span id="busuanzi_container_site_pv">本站总访问：<span id="busuanzi_value_site_pv"></span>次 &nbsp;&nbsp;&nbsp;&nbsp;</span></p><p></p></div></div></div></footer><script src="/js/highlight.pack.js"></script><script>document.addEventListener("DOMContentLoaded",function(e){Array.prototype.slice.call(document.getElementsByTagName("pre")).forEach(function(e,t){hljs.highlightBlock(e)})})</script></body></html>