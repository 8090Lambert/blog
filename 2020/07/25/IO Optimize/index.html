<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=""><meta name="author" content="8090Lambert"><meta name="google-site-verification" content="NlVkPYQIz-6FEWSYj-zlvN-gVromFNmq2v7hUK_WyyM"><meta name="sogou_site_verification" content="GFRFxFpBEM"><meta property="og:title" content="IO Optimize"><meta property="og:description" content="A Programmer With Coding."><meta property="og:site_name" content="8090Lambert | Blog"><meta property="og:type" content="article"><meta property="og:image" content="http://8090lambert.cn"><link rel="alternate" href="/atom.xml" title="8090Lambert | Blog" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><title>8090Lambert | Blog</title><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-146263529-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script>var _hmt=_hmt||[]</script><script async src="//hm.baidu.com/hm.js?dfc9714182f4393d85cb19cc7ad9c231"></script></head><body><nav class="navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="collapse navbar-collapse site-menu"><ul class="nav navbar-nav navbar-right"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/about">About</a></li><li> <a href="mailto:<juzs215@gmail.com>">Email</a></li><li><a href="https://github.com/8090Lambert"><i class="icon fa fa-github fa-lg"></i></a></li></ul></div></div></nav><header class="site-header header-background intro-header" style="background-image:url(/img/banner.jpg)"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="page-title with-background-image"><p class="title">IO Optimize</p><p class="subtitle"></p></div></div></div></div></header><article><div class="container typo"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-info text-muted"> <span class="author info">By 8090Lambert</span> <span class="date-time info">On <span class="date">2020-07-25T11:15:05+08:00</span></span></div><div class="post-tags text-muted"> Tags: <a class="tag" href="/tags/linux/">#linux</a></div><div class="post-content"><h2 id="一、传统IO传输"><a href="#一、传统IO传输" class="headerlink" title="一、传统IO传输"></a>一、传统IO传输</h2><p>传统的数据传输，不论是文件，还是写文件，都是会经过从 磁盘-》内核缓冲区 -》用户应用缓冲区 -》Socket 缓冲区 -》 网卡，这些步骤。这其中，会涉及到 4次用户态到内核态的上下文切换、4次用户态和内核态之间的数据拷贝。<br><img src="http://8090lambert.cn/images/blog/iooptimize/origin_io.jpg" alt="origin"></p><p>以读文件为例：<br>线程在用户空间发起read()读文件，线程从用户态切换为内核态<br>DMA将磁盘数据拷贝到内核缓存后，CPU又将数据从内核缓存拷贝至用户缓存，这时线程又从内核态切换为用户态<br>CPU将数据从用户缓存拷贝至socket缓存，线程又从用户态切换到内核态<br>DMA将数据从内核缓存拷贝到网卡，read()调用结束返回，线程又从内核态切换到用户态</p><h3 id="方式一：mmap-write实现零拷贝"><a href="#方式一：mmap-write实现零拷贝" class="headerlink" title="方式一：mmap + write实现零拷贝"></a>方式一：mmap + write实现零拷贝</h3><p><img src="http://8090lambert.cn/images/blog/iooptimize/mmap_io.jpg" alt="mmap"><br>mmap，Memory Mapped Files：简称 mmap，也有叫 MMFile 的，使用 mmap 的目的是将内核中读缓冲区（read buffer）的地址与用户空间的缓冲区（user buffer）进行映射。从而实现内核缓冲区与应用程序内存的共享，省去了将数据从内核读缓冲区（read buffer）拷贝到用户缓冲区（user buffer）的过程。它的工作原理是直接利用操作系统的 Page 来实现文件到物理内存的直接映射。完成映射之后你对物理内存的操作会被同步到硬盘上。<br>使用这种方式可以获取很大的 I/O 提升，省去了用户空间到内核空间复制的开销，在用户态对映射区域的写操作数据会同时在内核态缓存中存在<br>用户空间发起mmap系统调用<br>DMA将数据从文件系统拷贝到内核缓存中，并和用户空间堆外缓存建立映射关系<br>CPU从用户缓存读取到数据后，将数据拷贝到socket缓存中，线程从用户态切换到内核态<br>DMA将数据从socket缓存拷贝到网卡，调用write()结束后返回，线程从内核态切换到用户态<br>整个过程发生了3次拷贝，2次DMA，1次CPU；4次线程切换</p><h3 id="方式二：sendfile"><a href="#方式二：sendfile" class="headerlink" title="方式二：sendfile"></a>方式二：sendfile</h3><p><img src="http://8090lambert.cn/images/blog/iooptimize/sendfile_io.jpg" alt="sendfile"><br>sendfile，在Linux内核2.1版本之后，提供了sendfile()函数<br>sendfile(int out_fd, int in_fd, off_t *offset, size_t count);</p><p>// out_fd 参数代表待写入的文件描述符<br>// in_fd 参数代表待读取的文件描述符<br>// *offset 参数代表指定从读取文件流的哪个位置开始读，为空时则使用读入文件流默认的起始位置<br>// count 参数代表传输的字节数<br>sendfile函数实现了内核态和用户态之间的“零拷贝”：就是将数据的拷贝全部控制在内核态中，省去传统读取文件方式中 2次上下文切换 和 2次数据拷贝（伴随着上下文切换时，发生在内核态到用户态之间的拷贝），具体步骤如下：<br>用户空间发起sendfile()函数调用，设置读取数据和写入输入的文件描述符、读取字节的偏移量、读取的字节长度，进程从用户态切换到内核态<br>DMA 把磁盘的数据拷贝到内核缓存(Page Cache)中<br>CPU 从内核缓存中，将数据拷贝至socket缓存中<br>DMA 将socket缓存中的数据拷贝至网卡，sendfile调用完成，进程由内核态切换至用户态</p><p>整个过程发生了 2次上下文切换 和 3次数据拷贝，和上文说的貌似不一致。没错，在 sendfile()的 man page 中有这样的定义：In Linux kernels before 2.6.33, out_fd must refer to a socket. Since Linux 2.6.33 it can be any file. 因此，在Linux 2.6.33 之前的内核版本，写入的 fd 必须为 socket，因此数据在内核缓冲区后，需要再次拷贝到socket缓冲区，而在 2.6.33 版本之后的实现略有不同<br><img src="http://8090lambert.cn/images/blog/iooptimize/sendfile_optimize.jpg" alt="sendfile_optimize"></p><p>如图，当数据被拷贝至内核缓冲区时，通过DMA Gather控制器，直接拷贝至网卡。因为全程没有cpu参与数据的搬运，所有的数据都是通过 DMA 来进行传输的，实现了真正意义上的“零拷贝”。</p><p>Reference<br><a href="https://www.cnblogs.com/xiaolincoding/p/13719610.html" target="_blank" rel="noopener">https://www.cnblogs.com/xiaolincoding/p/13719610.html</a><br><a href="https://www.cnblogs.com/ericli-ericli/articles/12923420.html" target="_blank" rel="noopener">https://www.cnblogs.com/ericli-ericli/articles/12923420.html</a></p></div><section class="comments" id="comments"><div id="gitment_thread"></div><link rel="stylesheet" href="//unpkg.com/gitment/style/default.css"><script src="//unpkg.com/gitment/dist/gitment.browser.js"></script><script>var gitment=new Gitment({id:"{{ page.date }}",owner:"8090Lambert",repo:"8090Lambert.github.io",oauth:{client_id:"b2e729afbaa762a4cecc",client_secret:"cb9b28cda56154edecbcf76d2ea66e5a0e12c209"}});gitment.render("comments")</script></section></div></div></div></article><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><p class="copyright text-muted"> &copy; 2016 - 2021<span class="with-love"><i class="fa fa-heart"></i></span> <span class="author">8090Lambert</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></p><p class="visit-statistics"> <span id="busuanzi_container_site_pv">本站总访问：<span id="busuanzi_value_site_pv"></span>次 &nbsp;&nbsp;&nbsp;&nbsp;</span></p><p></p></div></div></div></footer><script src="/js/highlight.pack.js"></script><script>document.addEventListener("DOMContentLoaded",function(e){Array.prototype.slice.call(document.getElementsByTagName("pre")).forEach(function(e,t){hljs.highlightBlock(e)})})</script></body></html>